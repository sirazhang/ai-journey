# Gemini API Rate Limit (429 Error) 处理

## 问题说明
HTTP 状态码 429 表示 "Too Many Requests"（请求过多），这是 API 速率限制错误。

## 原因
1. **免费配额限制**：Gemini API 免费层有请求次数限制
   - 每分钟：15 个请求
   - 每天：1500 个请求
2. **频繁调用**：短时间内发送了太多请求
3. **图像生成消耗大**：`gemini-2.5-flash-image` 模型消耗更多配额

## 当前错误处理
代码已经添加了优雅的降级处理：

### 1. generateIdea() - 生成创意
- **429 错误**：返回默认的故事开头
- **其他错误**：返回随机形状和默认故事
- **用户体验**：功能仍然可用，只是使用预设内容

### 2. polishStory() - 润色故事
- **429 错误**：返回用户原始输入
- **其他错误**：返回用户原始输入
- **用户体验**：用户的故事保持不变

### 3. generateMagicImage() - 生成魔法图像
- **429 错误**：返回用户原始绘画
- **其他错误**：返回用户原始绘画
- **用户体验**：用户的绘画保持不变，不会丢失

## 解决方案

### 短期解决（立即）
1. **等待配额重置**
   - 每分钟配额：等待 1 分钟
   - 每天配额：等待到第二天（UTC 时间）
2. **减少测试频率**
   - 避免频繁刷新页面
   - 避免连续多次点击生成按钮

### 中期解决（开发阶段）
1. **使用多个 API 密钥**
   - 创建多个 Google Cloud 项目
   - 轮换使用不同的 API 密钥
2. **添加本地缓存**
   - 缓存已生成的内容
   - 避免重复请求相同内容

### 长期解决（生产环境）
1. **升级到付费计划**
   - Google AI Studio 付费计划
   - 更高的配额限制
2. **实现后端代理**
   - 在后端服务器管理 API 调用
   - 实现请求队列和速率限制
   - 保护 API 密钥不暴露在前端
3. **添加用户提示**
   - 显示 "API 配额已用完，请稍后再试"
   - 提供降级功能说明

## 当前实现的优势
- ✅ **不会崩溃**：所有 API 调用都有 fallback
- ✅ **不丢失数据**：用户的输入和绘画都会保留
- ✅ **用户友好**：功能仍然可用，只是使用原始内容
- ✅ **控制台提示**：开发者可以看到清晰的错误信息

## 监控建议
在生产环境中，建议添加：
1. **错误追踪**：记录 429 错误的频率
2. **用户通知**：友好地告知用户配额限制
3. **配额监控**：实时监控 API 使用情况
4. **降级策略**：自动切换到备用 API 或本地处理

## 相关文件
- `src/services/geminiService.js` - API 调用和错误处理
- `src/config/api.js` - API 配置
- `.env` - API 密钥配置
